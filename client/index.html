<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Appliance Fix Help</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
    body { background:#f4f6f9; color:#333; line-height:1.6; }
    header { background:linear-gradient(135deg,#4a90e2,#0077cc); color:#fff; padding:2rem 1rem; text-align:center; box-shadow:0 4px 8px rgba(0,0,0,.1); }
    h1 { font-size:2.2rem; margin-bottom:.5rem; }
    .container { max-width:1200px; margin:2rem auto; padding:0 1rem; }
    .tabs { display:flex; margin-bottom:1.5rem; border-bottom:2px solid #ddd; }
    .tab { padding:1rem 1.5rem; cursor:pointer; font-weight:600; transition:all .3s; border-bottom:3px solid transparent; }
    .tab.active { color:#4a90e2; border-bottom-color:#4a90e2; }
    .tab-content { display:none; background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .tab-content.active { display:block; }
    .form-group { margin-bottom:1.2rem; }
    label { display:block; margin-bottom:.5rem; font-weight:600; color:#444; }
    input[type=text], textarea, select { width:100%; padding:.8rem; border:1px solid #ccc; border-radius:8px; font-size:1rem; transition:border .3s; }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#4a90e2; box-shadow:0 0 0 3px rgba(74,144,226,.2); }
    textarea { min-height:120px; resize:vertical; }
    .upload-area { border:2px dashed #aaa; border-radius:12px; padding:2rem; text-align:center; cursor:pointer; transition:all .3s; background:#f9fdfc; }
    .upload-area:hover { border-color:#4a90e2; background:#f0f7ff; }
    .upload-area.dragover { border-color:#4a90e2; background:#e6f3ff; }
    .upload-area i { font-size:3rem; color:#aaa; margin-bottom:1rem; }
    .preview-img { max-width:100%; max-height:300px; margin-top:1rem; border-radius:8px; display:none; }
    .btn { background:#4a90e2; color:#fff; border:none; padding:.8rem 1.5rem; font-size:1rem; border-radius:8px; cursor:pointer; transition:background .3s; font-weight:600; }
    .btn:hover { background:#357abd; }
    .btn:disabled { background:#aaa; cursor:not-allowed; }
    .requests-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:1.5rem; margin-top:1rem; }
    .request-card { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.08); transition:transform .3s,box-shadow .3s; }
    .request-card:hover { transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,.12); }
    .request-img { width:100%; height:200px; object-fit:cover; }
    .request-body { padding:1.2rem; }
    .request-title { font-weight:700; font-size:1.2rem; margin-bottom:.5rem; color:#333; }
    .request-desc { color:#555; margin-bottom:1rem; font-size:.95rem; }
    .request-meta { display:flex; justify-content:space-between; align-items:center; font-size:.9rem; color:#777; margin-bottom:.8rem; }
    .distance { font-weight:600; color:#4a90e2; }
    .status { padding:.3rem .8rem; border-radius:20px; font-size:.8rem; font-weight:600; }
    .status.pending { background:#fff3cd; color:#856404; }
    .status.has-offers { background:#d4edda; color:#155724; }
    .offer-help { display:flex; align-items:center; gap:.5rem; }
    .offer-help input { width:70px; padding:.4rem; border:1px solid #ddd; border-radius:6px; text-align:center; }
    .offer-btn { background:#28a745; color:#fff; border:none; padding:.5rem 1rem; border-radius:6px; cursor:pointer; font-size:.9rem; font-weight:600; }
    .offer-btn:hover { background:#218838; }
    .no-requests { text-align:center; padding:3rem; color:#777; font-style:italic; }
    .filter-bar { display:flex; gap:.5rem; align-items:center; margin-bottom:1rem; flex-wrap:wrap; }
    .filter-bar label { margin-right:.5rem; }
    .map-container { height:400px; margin-bottom:1.5rem; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    @media (max-width:768px) {
      .requests-grid { grid-template-columns:1fr; }
      .offer-help { flex-direction:column; }
      .offer-help input { width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Appliance Fix Help</h1>
    <p>Upload a photo, add your location, and get help from nearby fixers.</p>
  </header>

  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="create">Create Request</div>
      <div class="tab" data-tab="view">View Requests</div>
    </div>

    <!-- CREATE REQUEST -->
    <div id="create" class="tab-content active">
      <form id="requestForm">
        <div class="form-group">
          <label for="applianceName">Appliance Name</label>
          <input type="text" id="applianceName" placeholder="e.g., Samsung Refrigerator" required>
        </div>

        <div class="form-group">
          <label for="issueDescription">Describe the Issue</label>
          <textarea id="issueDescription" placeholder="What’s wrong?" required></textarea>
        </div>

        <div class="form-group">
          <label for="city">City / Town</label>
          <div style="display:flex;gap:.5rem;">
            <input type="text" id="city" placeholder="e.g., Austin" required style="flex:1;">
            <button type="button" id="geoBtn" class="btn" style="padding:.5rem 1rem;">Get My Location</button>
          </div>
          <small id="geoStatus" style="color:#666;"></small>
        </div>

        <div class="form-group">
          <label for="zip">ZIP / Postal Code (optional)</label>
          <input type="text" id="zip" placeholder="e.g., 78701">
        </div>

        <div class="form-group">
          <label>Upload Photo</label>
          <div id="uploadArea" class="upload-area">
            <p>Camera</p>
            <p>Drag & drop an image or click to select</p>
            <input type="file" id="photoInput" accept="image/*" hidden>
          </div>
          <img id="preview" class="preview-img" alt="Preview">
        </div>

        <button type="submit" class="btn" id="submitBtn" disabled>Submit Request</button>
      </form>
    </div>

    <!-- VIEW REQUESTS -->
    <div id="view" class="tab-content">
      <div class="filter-bar">
        <label for="maxDist">Show within</label>
        <input type="number" id="maxDist" min="1" max="500" value="50" style="width:70px;">
        <select id="unit">
          <option value="km">km</option>
          <option value="mi">miles</option>
        </select>
        <button id="applyFilter" class="btn" style="padding:.4rem .8rem;">Apply</button>
        <button id="resetLoc" class="btn" style="background:#dc3545;padding:.4rem .8rem;">Reset Location</button>
      </div>

      <div id="map" class="map-container"></div>

      <div id="requestsContainer">
        <p class="no-requests">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // === CONFIG ===
      const API_URL = 'https://your-api.onrender.com/api/requests'; // CHANGE WHEN DEPLOYED
      const USE_LOCALSTORAGE = true; // Set to false when API is live

      let requests = [];
      let myPosition = null;
      let map = null;
      let markersLayer = null;
      let currentImage = null;

      // === DOM ELEMENTS ===
      const requestForm = document.getElementById('requestForm');
      const uploadArea = document.getElementById('uploadArea');
      const photoInput = document.getElementById('photoInput');
      const preview = document.getElementById('preview');
      const submitBtn = document.getElementById('submitBtn');
      const geoBtn = document.getElementById('geoBtn');
      const geoStatus = document.getElementById('geoStatus');
      const viewTab = document.querySelector('[data-tab="view"]');
      const applyFilter = document.getElementById('applyFilter');
      const resetLoc = document.getElementById('resetLoc');

      // === HELPERS ===
      function haversine(lat1, lon1, lat2, lon2, unit = 'km') {
        const toRad = v => v * Math.PI / 180;
        const R = unit === 'km' ? 6371 : 3959;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      async function reverseGeocode(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          return data.address?.city || data.address?.town || data.address?.village || '';
        } catch { return ''; }
      }

      function saveToLocal() {
        if (USE_LOCALSTORAGE) localStorage.setItem('applianceRequests', JSON.stringify(requests));
      }

      function loadFromLocal() {
        if (USE_LOCALSTORAGE) {
          const data = localStorage.getItem('applianceRequests');
          requests = data ? JSON.parse(data) : [];
        }
      }

      // === IMAGE UPLOAD ===
      uploadArea.addEventListener('click', () => photoInput.click());
      ['dragenter','dragover','dragleave','drop'].forEach(ev => {
        uploadArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
      });
      ['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.add('dragover')));
      ['dragleave','drop'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.remove('dragover')));

      uploadArea.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length) handleFile(files[0]);
      });
      photoInput.addEventListener('change', () => {
        if (photoInput.files.length) handleFile(photoInput.files[0]);
      });

      function handleFile(file) {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          currentImage = e.target.result;
          preview.src = currentImage;
          preview.style.display = 'block';
          checkForm();
        };
        reader.readAsDataURL(file);
      }

      // === FORM VALIDATION ===
      function checkForm() {
        const name = document.getElementById('applianceName')?.value.trim();
        const desc = document.getElementById('issueDescription')?.value.trim();
        const city = document.getElementById('city')?.value.trim();
        submitBtn.disabled = !(name && desc && city && currentImage);
      }
      ['applianceName','issueDescription','city'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', checkForm);
      });

      // === GEOLOCATION ===
      geoBtn.addEventListener('click', () => {
        if (!navigator.geolocation) return geoStatus.textContent = 'Not supported';
        geoStatus.textContent = 'Locating…';
        navigator.geolocation.getCurrentPosition(async pos => {
          const {latitude, longitude} = pos.coords;
          const city = await reverseGeocode(latitude, longitude);
          document.getElementById('city').value = city || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
          myPosition = {lat: latitude, lng: longitude, city};
          geoStatus.textContent = city ? `Located: ${city}` : 'Location found';
          checkForm();
        }, err => geoStatus.textContent = 'Failed: ' + err.message, {timeout: 10000});
      });

      // === SUBMIT REQUEST ===
      requestForm.addEventListener('submit', async e => {
        e.preventDefault();

        const newReq = {
          id: Date.now().toString(),
          applianceName: document.getElementById('applianceName').value.trim(),
          issueDescription: document.getElementById('issueDescription').value.trim(),
          image: currentImage,
          location: myPosition ? { lat: myPosition.lat, lng: myPosition.lng, city: myPosition.city } : { city: document.getElementById('city').value.trim() },
          zip: document.getElementById('zip').value.trim(),
          createdAt: new Date().toLocaleString(),
          offers: []
        };

        if (USE_LOCALSTORAGE) {
          requests.unshift(newReq);
          saveToLocal();
          alert('Request created!');
          e.target.reset();
          preview.src = ''; preview.style.display = 'none';
          currentImage = null; myPosition = null;
          submitBtn.disabled = true;
          geoStatus.textContent = '';
          viewTab.click();
        } else {
          const formData = new FormData();
          Object.keys(newReq).forEach(k => {
            if (k === 'location') formData.append('lat', newReq.location.lat || '');
            else if (k === 'image' && photoInput.files[0]) formData.append('image', photoInput.files[0]);
            else formData.append(k, newReq[k]);
          });

          try {
            const res = await fetch(API_URL, { method: 'POST', body: formData });
            if (res.ok) {
              alert('Request created!');
              e.target.reset();
              preview.src = ''; preview.style.display = 'none';
              currentImage = null; myPosition = null;
              submitBtn.disabled = true;
              geoStatus.textContent = '';
              viewTab.click();
            }
          } catch (e) {
            alert('Upload failed.');
          }
        }
      });

      // === FETCH & RENDER ===
      async function fetchRequests() {
        if (USE_LOCALSTORAGE) {
          loadFromLocal();
          initMapAndRender();
        } else {
          try {
            const res = await fetch(API_URL);
            requests = await res.json();
            requests.forEach(r => r.location = typeof r.location === 'string' ? JSON.parse(r.location) : r.location);
            initMapAndRender();
          } catch (e) {
            document.getElementById('requestsContainer').innerHTML = `<p class="no-requests">Failed to load.</p>`;
          }
        }
      }

      viewTab.addEventListener('click', fetchRequests);
      applyFilter.addEventListener('click', initMapAndRender);
      resetLoc.addEventListener('click', () => { myPosition = null; geoStatus.textContent = ''; initMapAndRender(); });

      // === MAP & CARDS ===
      function initMapAndRender() {
        const container = document.getElementById('requestsContainer');
        const maxDist = parseFloat(document.getElementById('maxDist').value) || 50;
        const unit = document.getElementById('unit').value;

        const filtered = myPosition
          ? requests.filter(r => r.location.lat && haversine(myPosition.lat, myPosition.lng, r.location.lat, r.location.lng, unit) <= maxDist)
          : requests.filter(r => r.location.lat);

        if (!map) {
          map = L.map('map').setView([51.505, -0.09], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
          markersLayer = L.layerGroup().addTo(map);
        }
        markersLayer.clearLayers();

        if (filtered.length === 0) {
          container.innerHTML = `<p class="no-requests">No requests in range.</p>`;
          return;
        }

        const bounds = [];
        filtered.forEach(req => {
          const marker = L.marker([req.location.lat, req.location.lng])
            .addTo(markersLayer)
            .bindPopup(`<b>${req.applianceName}</b><br>${req.location.city}<br><button class="popup-view-btn" data-id="${req.id}">View</button>`)
            .on('popupopen', () => {
              document.querySelectorAll('.popup-view-btn').forEach(btn => {
                btn.onclick = () => {
                  map.closePopup();
                  const card = document.getElementById('req-' + req.id);
                  card?.scrollIntoView({behavior: 'smooth'});
                };
              });
            });
          bounds.push([req.location.lat, req.location.lng]);
        });

        if (myPosition) {
          map.setView([myPosition.lat, myPosition.lng], 11);
          L.circle([myPosition.lat, myPosition.lng], {radius: maxDist * (unit === 'km' ? 1000 : 1609), color: '#4a90e2', fillOpacity: 0.1}).addTo(map);
        } else {
          map.fitBounds(bounds, {padding: [50, 50]});
        }

        container.innerHTML = '<div class="requests-grid"></div>';
        const grid = container.querySelector('.requests-grid');
        filtered.forEach(req => {
          const distance = myPosition ? haversine(myPosition.lat, myPosition.lng, req.location.lat, req.location.lng, unit).toFixed(1) : null;
          const card = document.createElement('div');
          card.className = 'request-card';
          card.id = 'req-' + req.id;
          card.innerHTML = `
            <img src="${req.image}" class="request-img" alt="${req.applianceName}">
            <div class="request-body">
              <div class="request-title">${req.applianceName}</div>
              <div class="request-desc">${req.issueDescription}</div>
              <div class="request-meta">
                <span>Posted: ${req.createdAt}</span>
                ${distance ? `<span class="distance">${distance} ${unit} away</span>` : ''}
              </div>
              <div class="offer-help">
                <input type="number" placeholder="Fee ($)" min="5" max="200" class="fee-input">
                <button class="offer-btn" data-id="${req.id}">Offer Help</button>
              </div>
            </div>
          `;
          const btn = card.querySelector('.offer-btn');
          btn.addEventListener('click', () => {
            const fee = card.querySelector('.fee-input').value;
            if (fee < 5 || fee > 200) return alert('Fee $5–$200');
            const name = prompt('Name:');
            const phone = prompt('Phone:');
            if (name && phone) alert(`Offer of $${fee} sent!`);
          });
          grid.appendChild(card);
        });
      }

      // === TAB SWITCHING ===
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });

      // Initial load
      loadFromLocal();
      initMapAndRender();
    });
  </script>
</body>
</html>
